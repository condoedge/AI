# Entity Configuration

Complete guide to configuring entities for the AI system.

---

## Overview

Entities are your Eloquent models that you want to query using natural language. Each entity needs configuration for:

- **Graph (Neo4j)**: Node labels, properties, and relationships
- **Vector (Qdrant)**: Embeddings for semantic search
- **Metadata**: Aliases, scopes, and descriptions

---

## Configuration Methods

There are three ways to configure entities, listed by priority (highest first):

### 1. `nodeableConfig()` Method (Highest Priority)

Define configuration directly in your model:

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Condoedge\Ai\Domain\Contracts\Nodeable;
use Condoedge\Ai\Domain\Traits\HasNodeableConfig;
use Condoedge\Ai\Domain\ValueObjects\NodeableConfig;

class Customer extends Model implements Nodeable
{
    use HasNodeableConfig;

    public function nodeableConfig(): NodeableConfig
    {
        return NodeableConfig::for(static::class)
            ->label('Customer')
            ->properties('id', 'name', 'email', 'status')
            ->relationship('orders', 'Order', 'HAS_ORDER', 'customer_id')
            ->collection('customers')
            ->embedFields('name', 'email', 'company')
            ->metadata(['id', 'name', 'status'])
            ->aliases('customer', 'client', 'account')
            ->description('Customer entity with orders');
    }
}
```

**Best for:** Dynamic configuration, type safety, IDE autocomplete.

### 2. `config/entities.php` (Middle Priority)

Generated by `php artisan ai:discover`:

```php
return [
    'App\\Models\\Customer' => [
        'graph' => [
            'label' => 'Customer',
            'properties' => ['id', 'name', 'email', 'status'],
            'relationships' => [
                [
                    'type' => 'HAS_ORDER',
                    'target_label' => 'Order',
                    'foreign_key' => 'customer_id',
                ],
            ],
        ],
        'vector' => [
            'collection' => 'customers',
            'embed_fields' => ['name', 'email', 'company'],
            'metadata' => ['id', 'name', 'status'],
        ],
        'metadata' => [
            'aliases' => ['customer', 'client', 'account'],
            'description' => 'Customer entity',
        ],
    ],
];
```

**Best for:** Centralized configuration, auto-generated configs.

### 3. Runtime Auto-Discovery (Lowest Priority)

Automatically analyzes models at runtime. **Disabled by default** for performance.

```env
AI_AUTO_DISCOVERY_RUNTIME=true  # Only for dev/testing!
```

**Best for:** Development, prototyping, learning.

---

## Graph Configuration

### Node Label

The Neo4j node label (usually singular, PascalCase):

```php
// NodeableConfig
->label('Customer')

// config/entities.php
'graph' => [
    'label' => 'Customer',
]
```

### Properties

Properties stored in Neo4j (should include primary key):

```php
// NodeableConfig
->properties('id', 'name', 'email', 'status', 'created_at')

// config/entities.php
'graph' => [
    'properties' => ['id', 'name', 'email', 'status', 'created_at'],
]
```

**Excluded by default:** `password`, `remember_token`, `api_token`, `secret`, sensitive fields.

### Relationships

Define how entities connect:

```php
// NodeableConfig
->relationship('orders', 'Order', 'HAS_ORDER', 'customer_id')
->relationship('team', 'Team', 'BELONGS_TO', 'team_id')

// config/entities.php
'graph' => [
    'relationships' => [
        [
            'type' => 'HAS_ORDER',           // Relationship type (UPPER_SNAKE_CASE)
            'target_label' => 'Order',       // Target node label
            'foreign_key' => 'customer_id',  // Foreign key column
            'direction' => 'outgoing',       // outgoing (default) or incoming
            'inverse_type' => 'PLACED_BY',   // Optional: inverse relationship
        ],
    ],
]
```

**Relationship naming conventions:**
- `HAS_*` - One-to-many (Customer HAS_ORDER Order)
- `BELONGS_TO` - Many-to-one (Order BELONGS_TO Customer)
- `*_BY` - Inverse relationships (Order PLACED_BY Customer)

---

## Vector Configuration

### Collection Name

Qdrant collection for embeddings:

```php
// NodeableConfig
->collection('customers')

// config/entities.php
'vector' => [
    'collection' => 'customers',
]
```

**Collections are auto-created** with correct dimensions on first use.

### Embed Fields

Fields to generate embeddings from (for semantic search):

```php
// NodeableConfig
->embedFields('name', 'description', 'company')

// config/entities.php
'vector' => [
    'embed_fields' => ['name', 'description', 'company'],
]
```

**Tips:**
- Include text fields users might search by
- Avoid IDs, dates, or numeric-only fields
- 2-4 fields is usually optimal

### Metadata

Fields stored as filterable metadata in Qdrant:

```php
// NodeableConfig
->metadata(['id', 'status', 'tier', 'created_at'])

// config/entities.php
'vector' => [
    'metadata' => ['id', 'status', 'tier', 'created_at'],
]
```

**Always include:**
- Primary key (`id`)
- Fields you'll filter by (status, type, category)
- Fields needed for display in results

---

## Metadata Configuration

### Aliases

Alternative names the LLM should recognize:

```php
// NodeableConfig
->aliases('customer', 'client', 'buyer', 'account')

// config/entities.php
'metadata' => [
    'aliases' => ['customer', 'client', 'buyer', 'account'],
]
```

**Example queries that work with aliases:**
- "Show all customers"
- "List clients with status active"
- "Find buyers from USA"

### Description

Human-readable description for LLM context:

```php
// NodeableConfig
->description('Customer entity representing business clients with order history')

// config/entities.php
'metadata' => [
    'description' => 'Customer entity representing business clients with order history',
]
```

### Scopes

Predefined query filters the LLM can use:

```php
// config/entities.php
'metadata' => [
    'scopes' => [
        'active' => [
            'name' => 'active',
            'cypher_pattern' => "n.status = 'active'",
            'description' => 'Filter to active customers only',
            'example_queries' => [
                'Show active customers',
                'List all active clients',
            ],
        ],
        'premium' => [
            'name' => 'premium',
            'cypher_pattern' => "n.tier IN ['gold', 'platinum']",
            'description' => 'Filter to premium tier customers',
            'example_queries' => [
                'Show premium customers',
                'List gold and platinum clients',
            ],
        ],
    ],
]
```

**Scopes auto-discovered from:**
- Laravel query scopes (`scopeActive`, `scopePremium`)
- Discriminator fields via traversal scope generation

See: [Scopes & Business Logic](/docs/{{version}}/advanced/scopes)

---

## Complete NodeableConfig API

```php
public function nodeableConfig(): NodeableConfig
{
    return NodeableConfig::for(static::class)
        // Graph Configuration
        ->label('Customer')                    // Neo4j node label
        ->properties('id', 'name', 'email')    // Properties to store
        ->relationship(                        // Add relationship
            'orders',                          // Eloquent relation name
            'Order',                           // Target node label
            'HAS_ORDER',                       // Relationship type
            'customer_id'                      // Foreign key
        )

        // Vector Configuration
        ->collection('customers')              // Qdrant collection
        ->embedFields('name', 'company')       // Fields to embed
        ->metadata(['id', 'status'])           // Filterable metadata

        // Metadata
        ->aliases('customer', 'client')        // Alternative names
        ->description('Customer entity')       // Description for LLM

        // Scopes
        ->scope('active', [
            'cypher_pattern' => "n.status = 'active'",
            'description' => 'Active customers',
            'example_queries' => ['Show active customers'],
        ])

        // Advanced
        ->autoSync(true)                       // Enable auto-sync
        ->queueSync(false);                    // Queue sync operations
}
```

---

## Auto-Discovery

Generate configuration automatically:

```bash
# Discover all Nodeable models
php artisan ai:discover

# Preview without writing
php artisan ai:discover --dry-run

# Discover specific model
php artisan ai:discover --model="App\Models\Customer"

# Include verbose output
php artisan ai:discover -v
```

### What Gets Discovered

| Feature | Auto-Discovered |
|---------|-----------------|
| Label | From class name |
| Properties | From fillable/table columns |
| Relationships | From Eloquent relations |
| Collection | From table name |
| Embed fields | Text columns (name, description, etc.) |
| Metadata | Key columns (id, status, type) |
| Aliases | From table name + common variations |
| Scopes | From Laravel query scopes |
| Traversal scopes | From relationship discriminators |

### Customizing Discovery

In `config/ai.php`:

```php
'auto_discovery' => [
    // Additional aliases for tables
    'alias_mappings' => [
        'customers' => ['client', 'buyer', 'account'],
        'orders' => ['purchase', 'transaction'],
    ],

    // Properties to exclude
    'exclude_properties' => [
        'internal_notes',
        'admin_only_field',
    ],

    // Role mappings for traversal scopes
    'role_mappings' => [
        'PersonTeam' => [
            'role_type' => [
                3 => 'volunteers',
                4 => 'scouts',
            ],
        ],
    ],
],
```

---

## Best Practices

### Do

- Run `ai:discover` to generate initial config
- Review and customize generated config
- Include primary key in properties and metadata
- Add meaningful aliases users might use
- Define scopes for common query patterns

### Don't

- Store sensitive data (passwords, tokens) in properties
- Use runtime discovery in production
- Embed numeric-only fields (IDs, amounts)
- Create too many overlapping aliases

---

## Related Documentation

- [Response Styles](/docs/{{version}}/configuration/response-styles) - Configure response verbosity
- [Environment Variables](/docs/{{version}}/configuration/environment) - All environment settings
- [Auto-Discovery](/docs/{{version}}/advanced/auto-discovery) - Deep dive into discovery
- [Scopes & Business Logic](/docs/{{version}}/advanced/scopes) - Advanced scope configuration
